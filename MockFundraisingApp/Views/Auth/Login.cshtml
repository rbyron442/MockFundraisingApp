@model MockFundraisingApp.ViewModels.LoginVm
@using System.Text.Json
@{
    ViewData["Title"] = "Sign in";
}

<section class="py-5 auth-shell">
    <div class="container py-4" style="max-width: 1100px;">
        <div class="row align-items-center justify-content-center g-5">

            <div class="col-md-8 col-lg-7 col-xl-6">
                <img src="~/images/login-illustration.svg"
                     class="img-fluid login-illustration"
                     alt="Sign in illustration" />
            </div>

            <div class="col-md-7 col-lg-5 col-xl-5 offset-xl-1">
                <div class="auth-card">
                    <div id="authErr" class="alert alert-danger" style="display:none;"></div>
                    <h2 class="auth-title mb-2">Sign in</h2>
                    <p class="auth-subtitle mb-4">
                        Continue with Google or Apple, or use email and password.
                    </p>

                    <div class="d-grid gap-2">
                        <button id="google-login-btn" type="button" class="auth-btn btn btn-google btn-lg">
                            <svg class="auth-icon" viewBox="0 0 48 48" aria-hidden="true">
                                <path fill="#EA4335" d="M24 9.5c3.54 0 6.7 1.22 9.19 3.6l6.85-6.85C35.9 2.35 30.4 0 24 0 14.82 0 6.73 5.48 3.19 13.44l7.98 6.2C13.2 13.5 18.17 9.5 24 9.5z" />
                                <path fill="#34A853" d="M46.1 24.5c0-1.63-.15-3.2-.43-4.7H24v9.02h12.43c-.54 2.9-2.16 5.35-4.6 7l7.16 5.57C43.96 37.1 46.1 31.4 46.1 24.5z" />
                                <path fill="#4A90E2" d="M10.98 28.64a14.5 14.5 0 010-9.28l-7.98-6.2A24 24 0 000 24c0 3.88.93 7.54 2.58 10.78l8.4-6.14z" />
                                <path fill="#FBBC05" d="M24 48c6.48 0 11.92-2.13 15.89-5.8l-7.16-5.57c-2 1.34-4.56 2.14-8.73 2.14-5.83 0-10.8-4-12.57-9.38l-8.4 6.14C6.7 42.52 14.82 48 24 48z" />
                            </svg>
                            Continue with Google
                        </button>

                        <button id="appleBtn" type="button" class="auth-btn btn btn-apple btn-lg">
                            <svg class="auth-icon" viewBox="0 0 24 24" aria-hidden="true">
                                <path fill="currentColor"
                                      d="M17.564 13.862c.03 3.263 2.86 4.35 2.892 4.363-.022.077-.455 1.56-1.503 3.09-.907 1.324-1.85 2.642-3.335 2.67-1.46.028-1.93-.866-3.603-.866-1.673 0-2.196.84-3.584.894-1.43.055-2.52-1.43-3.434-2.748-1.872-2.704-3.3-7.64-1.38-10.97.955-1.653 2.66-2.7 4.515-2.73 1.41-.028 2.74.95 3.603.95.864 0 2.487-1.175 4.194-1.003.714.03 2.72.288 4.01 2.17-.104.064-2.392 1.397-2.368 4.18ZM14.83 3.92c.76-.92 1.27-2.2 1.13-3.49-1.09.044-2.41.73-3.19 1.65-.7.81-1.31 2.1-1.14 3.34 1.22.095 2.43-.62 3.2-1.5Z" />
                            </svg>
                            Continue with Apple
                        </button>
                    </div>

                    <div class="divider d-flex align-items-center my-4">
                        <p class="text-center fw-bold mx-3 mb-0 text-muted">OR</p>
                    </div>

                    <form id="emailLoginForm" method="post" action="#" onsubmit="return false;">
                        <input type="hidden" name="returnUrl" value="@ViewBag.ReturnUrl" />

                        <div class="mb-4">
                            <label asp-for="Email" class="form-label"></label>
                            <input asp-for="Email" class="form-control form-control-lg" autocomplete="email" />
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>

                        <div class="mb-2">
                            <label asp-for="Password" class="form-label"></label>
                            <input asp-for="Password" class="form-control form-control-lg" autocomplete="current-password" />
                            <span asp-validation-for="Password" class="text-danger"></span>
                        </div>

                        <div class="d-grid gap-2 mt-3">
                            <button type="submit" class="auth-btn btn btn-primary btn-lg">
                                Sign in with email
                            </button>
                            <button id="signupEmailBtn" type="button" class="btn btn-outline-secondary btn-lg">
                                Create account
                            </button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    window.firebaseConfig = @Html.Raw(JsonSerializer.Serialize(ViewBag.Firebase));
    window.returnUrl = "@(ViewBag.ReturnUrl ?? "/")";
</script>


@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "@ViewBag.Firebase.apiKey",
          authDomain: "@ViewBag.Firebase.authDomain",
          projectId: "@ViewBag.Firebase.projectId"
        };

        const returnUrl = "@(ViewBag.ReturnUrl ?? "/")";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // TODO: set this to your actual button id
        const btn = document.getElementById("google-login-btn");

        if (!btn) {
          console.error("Google login button not found. Add id='google-login-btn' to the button.");
        } else {
          btn.addEventListener("click", async (e) => {
            e.preventDefault();

            try {
              const result = await signInWithPopup(auth, provider);
              const user = result.user;
              const idToken = await user.getIdToken();

              const resp = await fetch("/Auth/Session", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "same-origin",
                body: JSON.stringify({
                  idToken: idToken,
                  returnUrl: returnUrl,
                  accountCreated: false
                })
              });

              if (!resp.ok) {
                const text = await resp.text();
                throw new Error(`Session failed: ${resp.status} ${text}`);
              }

              const data = await resp.json();
              window.location.href = data.returnUrl || "/";
            } catch (err) {
              console.error(err);
              alert("Login failed. Check console for details.");
            }
          });
        }
    </script>
}
